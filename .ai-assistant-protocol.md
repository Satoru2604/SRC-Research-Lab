# AI Assistant Protocol - MANDATORY WORKFLOW

**This file defines the MANDATORY workflow for AI assistants (Claude, etc.) working on this repository.**

---

## CRITICAL RULE: NEVER WORK ON MASTER BRANCH

**üö® Before making ANY changes, you MUST create a feature branch! üö®**

---

## Workflow Protocol (FOLLOW EXACTLY)

### Phase 1: Pre-Work Verification (REQUIRED)

```bash
# Step 1: Check current branch
git branch --show-current
```

**Decision Tree**:
- If output is `master` or `main` ‚Üí **GO TO PHASE 2**
- If output is a feature branch ‚Üí **VERIFY IT'S CORRECT**, then proceed to Phase 3
- If uncertain ‚Üí **STOP and ask user**

---

### Phase 2: Create Feature Branch (REQUIRED if on master)

**NEVER skip this step!**

```bash
# Create branch with appropriate type
git checkout -b <type>/<description>
```

**Branch types**:
- `feature/` - New features (most common)
- `fix/` - Bug fixes
- `docs/` - Documentation only
- `refactor/` - Code improvements
- `test/` - Test additions
- `experiment/` - Research experiments
- `chore/` - Maintenance tasks

**Naming rules**:
- Lowercase only
- Use hyphens (not underscores or spaces)
- Be descriptive but concise
- Examples:
  - `feature/adaptive-leaderboard-phase-h4`
  - `fix/memory-leak-in-bridge`
  - `docs/update-api-reference`

**After creating branch**:
```bash
# Verify you're on the new branch
git branch --show-current
```

**Expected**: Should show your feature branch (NOT `master`)

---

### Phase 3: Make Changes

**Rules**:
1. Follow directory structure (`docs/engineeringculture.md#code-organization`)
2. Keep root directory clean
3. Use conventional commit messages
4. Test before committing

**File placement**:
- Scripts ‚Üí `scripts/`
- Tests ‚Üí `tests/`
- Documentation ‚Üí `docs/`
- Source code ‚Üí `src/` or appropriate module directory
- Results ‚Üí `results/` (gitignored)

---

### Phase 4: Commit Changes

**BEFORE each commit**:
```bash
# Verify NOT on master
git branch --show-current
```

**If on master**: üö® **STOP! Go back to Phase 2!** üö®

**Commit format**:
```bash
git add <files>
git commit -m "<type>(<scope>): <description>"
```

**Types**: `feat`, `fix`, `docs`, `refactor`, `test`, `chore`, `style`, `perf`

**Examples**:
```bash
git commit -m "feat(leaderboard): add adaptive integration script"
git commit -m "test(integration): add 12 unit tests for adaptive results"
git commit -m "docs(release): add Phase H.4 release notes"
```

**For large changes**:
```bash
git commit -m "feat(release): Phase H.4 implementation

- Added adaptive leaderboard integration
- Created public benchmark bundles
- Generated publication artifacts
- 99 tests passing

ü§ñ Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude <noreply@anthropic.com>"
```

---

### Phase 5: Pre-Push Verification

**Checklist (verify ALL before pushing)**:
- [ ] Current branch is NOT `master` (`git branch --show-current`)
- [ ] All tests pass (`pytest -q`)
- [ ] Files are in correct directories
- [ ] Root directory is clean
- [ ] Documentation is updated
- [ ] Commit messages follow convention

---

### Phase 6: Push Feature Branch

```bash
# Push to remote
git push -u origin <branch-name>
```

**Example**:
```bash
git push -u origin feature/adaptive-leaderboard-phase-h4
```

**NEVER** do this:
```bash
# ‚ùå WRONG - Don't push to master!
git push origin master
```

---

### Phase 7: Create Pull Request

**After pushing**, create a PR with:

**Title**: `<type>(<scope>): <description>`

**Example**: `feat(release): Phase H.4 - Adaptive CAQ Leaderboard Integration`

**Body template**:
```markdown
## Summary
- [List key changes]
- [Major features added]
- [Tests written]

## Test Plan
- [ ] All unit tests pass (X/X passing)
- [ ] Manual testing completed
- [ ] Documentation updated
- [ ] Security checks pass

## Related Issues
Closes #<issue-number> (if applicable)

## Performance
- Code additions: X lines
- New tests: X
- Total tests: X passing

ü§ñ Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude <noreply@anthropic.com>
```

---

## Emergency Procedures

### Emergency 1: Accidentally Committed to Master

**If you realize BEFORE pushing**:
```bash
# 1. Create feature branch from current state
git branch feature/emergency-fix

# 2. Reset master to origin
git reset --hard origin/master

# 3. Switch to feature branch (work is safe)
git checkout feature/emergency-fix

# 4. Push feature branch
git push -u origin feature/emergency-fix
```

**If you already pushed to master**:
1. **STOP immediately**
2. **Notify the user** of the mistake
3. **Ask the user** how they want to proceed:
   - Option A: Revert the commit on master
   - Option B: Create retrospective PR for documentation
   - Option C: Leave as-is if tests pass and user approves

---

### Emergency 2: Wrong Branch Name

**If you realize immediately after creating branch**:
```bash
# Rename current branch
git branch -m <old-name> <new-name>
```

**If already pushed**:
```bash
# Delete remote branch
git push origin --delete <old-name>

# Rename local branch
git branch -m <old-name> <new-name>

# Push with new name
git push -u origin <new-name>
```

---

## Automated Pre-Commit Checks

**Run these BEFORE every commit**:

```bash
#!/bin/bash
# Auto-check script

# 1. Verify not on master
BRANCH=$(git branch --show-current)
if [ "$BRANCH" = "master" ] || [ "$BRANCH" = "main" ]; then
    echo "‚ùå ERROR: Cannot commit to master/main branch!"
    echo "Create a feature branch first: git checkout -b feature/your-feature"
    exit 1
fi

# 2. Run tests
pytest -q
if [ $? -ne 0 ]; then
    echo "‚ùå ERROR: Tests failed!"
    exit 1
fi

# 3. Check file organization
if ls *.py 2>/dev/null | grep -v setup.py; then
    echo "‚ö†Ô∏è  WARNING: Python files in root directory!"
    echo "Move to appropriate subdirectory (scripts/, src/, tests/)"
fi

echo "‚úÖ Pre-commit checks passed"
```

---

## Learning from Phase H.4 Mistake

### What Went Wrong
- Phase H.4 work was done directly on `master` branch
- All commits went to `master` instead of feature branch
- No pull request was created for review

### What Should Have Happened
1. Create branch: `git checkout -b feature/adaptive-leaderboard-phase-h4`
2. Make all changes on that branch
3. Commit with conventional messages
4. Push feature branch: `git push -u origin feature/adaptive-leaderboard-phase-h4`
5. Create pull request on GitHub
6. Merge via "Squash and merge" after review

### Prevention Measures
1. **This file** - AI assistant protocol
2. **`.git-workflow-checklist.md`** - Workflow checklist
3. **Branch check before commit** - Mandatory verification
4. **User notification** - Alert if about to commit to master

---

## AI Assistant Self-Check Questions

Before making ANY change, ask yourself:

1. ‚úì Have I checked the current branch? (`git branch --show-current`)
2. ‚úì Am I on a feature branch (NOT master)?
3. ‚úì Is my branch name following conventions?
4. ‚úì Have I read the relevant engineering culture docs?
5. ‚úì Do I know where files should be placed?

Before making ANY commit, ask yourself:

1. ‚úì Am I still on the feature branch?
2. ‚úì Have tests been run and passed?
3. ‚úì Is my commit message conventional?
4. ‚úì Are files in correct directories?
5. ‚úì Is documentation updated?

Before pushing, ask yourself:

1. ‚úì Am I pushing to a feature branch (NOT master)?
2. ‚úì Have all tests passed?
3. ‚úì Is the work complete and ready for review?
4. ‚úì Will I create a PR after pushing?

---

## Integration with Development Workflow

### When User Asks for New Feature

**Your response should ALWAYS include**:

```markdown
I'll implement [feature name]. First, let me create a feature branch:

[Run: git checkout -b feature/descriptive-name]

Now I'll proceed with implementation...
```

### When Making Multiple Changes

**Create branch ONCE at start**:
```bash
git checkout -b feature/comprehensive-feature
```

**Then make all changes on that branch**:
- Multiple commits are fine
- All commits stay on feature branch
- Push once at the end (or periodically)
- Create single PR for all related changes

---

## Commit Message Templates

### Simple Feature
```
feat(scope): add feature X

Implements feature X with Y approach.
```

### Complex Feature
```
feat(scope): comprehensive feature implementation

## Changes
- Added component A
- Implemented functionality B
- Created tests C

## Testing
- 25 new unit tests
- All integration tests pass

ü§ñ Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude <noreply@anthropic.com>
```

### Bug Fix
```
fix(scope): resolve issue with X

Previously, Y would fail when Z. Now properly handles edge case.

Closes #123
```

### Documentation
```
docs(scope): update documentation for feature X

- Added usage examples
- Updated API reference
- Fixed typos
```

---

## References

- Engineering culture: `docs/engineeringculture.md`
- Git workflow checklist: `.git-workflow-checklist.md`
- Claude context: `.claude.md`

---

## Enforcement

**This protocol is MANDATORY**.

If you (AI assistant) violate this protocol:
1. User will be notified immediately
2. Corrective action will be taken
3. This file will be updated with lessons learned

**Success metrics**:
- ‚úÖ 0 direct commits to master
- ‚úÖ 100% of changes via feature branches
- ‚úÖ 100% of changes have pull requests
- ‚úÖ All commits follow conventional format

---

**Last Updated**: 2025-10-16
**Version**: 1.0
**Created After**: Phase H.4 master branch incident

**üö® READ AND FOLLOW THIS PROTOCOL FOR EVERY CHANGE üö®**
